---
title: "Analysis for Hoecker and Higuera XXXX: "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results  = 'hide', message = FALSE, warning = FALSE)
```

## Setup

Load the requisite packages.
```{r}
library(dplyr) # For data manipulation
library(zoo) # For rolling statistics 
library(ggplot2) # For plotting
library(knitr) # For formatting this file 
```

Specify directory on your machine containing data (ends with 'nowitna/data') and code (ends with 'nowitna/analysis')
```{r}
dataDir <- "/Users/tylerhoecker/GitHub/nowitna/data/"
codeDir <- "/Users/tylerhoecker/GitHub/nowitna/analysis"
```

Specify lakes and time period of analysis.
```{r}
lakes <- c('BB15','DU15','MA15','NW15','SH15','TL15','UR15') 
studyPeriod <- c(1550,2015)
```

Load charcoal data (data should be stored in the same directory as 'analysis.Rmd'). These data have already undergone peak analysis and interpolation in CharAnalysis (https://github.com/phiguera/CharAnalysis). Raw charcoal count data and CharAnalysis input files available here: [Figshare Link?]
```{r}
char.ldf <- lapply(paste0(dataDir,'charResults_',lakes,'.csv'),read.csv)   

char.df <- char.ldf %>%
  bind_rows() %>%
  mutate(ageCE = 1950 - ageTop,
         peakYr = ifelse(peaksFinal == 1,ageCE,NA),
         peakInsigYr = ifelse(peaksInsig == 1,ageCE,NA),
         peakYr1 = ifelse(peaks1 == 1,ageCE,NA),
         peakYr2 = ifelse(peaks2 == 1,ageCE,NA),
         peakYr3 = ifelse(peaks3 == 1,ageCE,NA)) %>%
  filter(ageCE >= studyPeriod[1]) %>%
  group_by(lake) %>%
         mutate(length = max(ageCE) - min(ageCE)) 
```

Load observed (historic) fire event data.
```{r}
observed.df <- read.csv(paste0(dataDir,'/observedfireData.csv'))
obs.1km <- filter(observed.df,distance == 1.0) %>%
  rename(obsCE = ageCE)
```

Load tree demography data.
```{r}

```


## Summarize fire event metrics 

Mean signal to noise indices of records during study period:
```{r results  = 'asis'}
kable(
  char.df %>% 
    summarise(meanSNI = mean(SNI, na.rm = T)) 
)
```

Study-wide mean FRI (mean of all FRI pooled, rather than mean of means):
```{r results  = 'asis'}
FRI <- char.df %>%
  select(lake,peakYr,length) %>%
  filter(!is.na(peakYr)) %>%
  mutate(FRI =  (lead(peakYr, 1) - peakYr) * -1) 

kable(
  FRI %>%
    ungroup(lake) %>%
    summarise(min = min(FRI, na.rm = T),
              max = max(FRI, na.rm = T),
              mean = mean(FRI, na.rm = T),
              median = median(FRI, na.rm = T),
              sd = sd(FRI, na.rm = T)) 
)
```

Individual mean FRI:
```{r results = 'asis'}
kable(
  FRI %>%
  group_by(lake) %>%
  summarise(nFires = n(),
            mFRI = mean(FRI, na.rm = T),
            sdFRI = sd(FRI, na.rm = T),
            length = length[1],
            FF = nFires/length * 100) 
)
```

Calculate the difference (in years) between observed fire years within 1km of lakes and the most recent fire event detected in charcoal record
```{r results = 'asis'}
char.df <- char.df %>%
  group_by(lake) %>%
  right_join(.,obs.1km, by = 'lake')

kable(
  char.df %>% 
  group_by(lake) %>%
  summarize(observed = obsCE[1],
            lastPeak = max(peakYr, na.rm = T),
            difference = abs(obsCE[1] - max(peakYr, na.rm = T)))
)
```



## Calculate proportion of sites burned through time, using 50-year windows in continuous 5-year time steps.
```{r}
window = 50
timeStep = 5

sitesByYear <- char.df %>%
  group_by(ageCE) %>%
  summarise(sites = n()) 

pctBurned <- char.df %>% 
  filter(!is.na(peakYr)) %>%
  group_by(peakYr) %>%
  summarise(n.burned = n()) %>%
  rename(ageCE = peakYr) %>%
  full_join(sitesByYear,.) %>%
  mutate(n.burned = ifelse(!is.na(n.burned),n.burned,0)) %>%
  # Window
  mutate(win.total = rollapply(sites, window/timeStep, fill= NA,
                               FUN = mean, na.rm =T)) %>%
  mutate(win.burn = rollsum(n.burned, window/timeStep, fill= NA)) %>%
  mutate(win.pct = win.burn/win.total*100) 


modernTime <- seq(1950,2015,1)
modernSites = data.frame('ageCE' = modernTime, 'sites' = 6)

pctModern <- observed.df %>%
  filter(distance == 1) %>%
  group_by(ageCE) %>%
  summarise(n.burned = n()) %>%
  full_join(modernSites,.) %>%
  mutate(n.burned = ifelse(!is.na(n.burned),n.burned,0)) %>%
  # Window
  mutate(win.total = rollapply(sites, window, fill= NA,
                               FUN = mean, na.rm =T)) %>%
  mutate(win.burn = rollsum(n.burned, window, fill= NA)) %>%
  mutate(win.pct = win.burn/win.total*100) 
```

Plot the result, a time series of FRI (grey squares), percent sites burned based on the charcoal record (black line), and percent sites burned based on observed fire data since 1950 (red line).
```{r pressure}
 ggplot(filter(pctBurned, ageCE>1550), aes(x = ageCE, y = win.pct)) +
  geom_step(data = pctModern, direction = 'vh', color = 'red3', size = 1) +
  geom_step(direction = 'vh') +
  geom_point(data = FRI, aes(x = peakYr, y = FRI/2), shape = 22, fill = 'grey50', size = 2) +
  scale_x_continuous(limits = studyPeriod, breaks = seq(studyPeriod[1],studyPeriod[2],50)) +
  scale_y_continuous(limits = c(0,100), sec.axis = sec_axis(trans = ~.*2,name = 'Fire return interval (yr)')) +
  labs(y = 'Percent of sites burned', x = 'Year CE') +
  theme_bw(base_size = 14)
```



## Build composite biomass burning recrod from individual records. 
Import raw charcoal count data.
```{r}
# Import selected regions / alaska 
dataframes <- lapply(paste0(dataDir,'charData_',lakes,'.csv'),read.csv) 
```
Derive and standardize charcoal accumulation rates (# cm2 yr-1, "CHAR").
```{r}
# Derive CHAR -------------------------------------------------------------
# Calculate and standardize CHAR 
for (i in 1:length(lakes)){
  # Calculate sediment accumulation rates (dataframes[[i]]$sedAcc) [cm/yr] 
  dataframes[[i]][,'sedAcc'] <- 
    (dataframes[[i]][,'cmTop']-dataframes[[i]][,'cmBot'])/
    (dataframes[[i]][,'ageTop']-dataframes[[i]][,'ageBot']) 
  # Calculate charcoal accumulation rates (dataframes[[i]]$char) [#/cm2/yr]
  dataframes[[i]][,'char'] <- 
    (dataframes[[i]][,'charCount']/dataframes[[i]][,'charVol'])*
    dataframes[[i]][,'sedAcc'] 
  # Log transform non-zero char
  nonZero <- which(dataframes[[i]][,'char'] > 0)
  transChar <- log(dataframes[[i]][nonZero,'char'])
  # Z-score transformed char
  zChar <- (transChar - mean(transChar, na.rm=T)) / sd(transChar, na.rm = T)
  # Exponentiate
  dataframes[[i]][nonZero,'char'] <- exp(zChar)
  # Average sample age (this added to work with RK scripts)
  dataframes[[i]][,'age'] <- 
    round(rowMeans(dataframes[[i]][,c('ageTop','ageBot')], na.rm = T))
  # Site/lake name
  dataframes[[i]][,'lake'] <- lakes[i]
}

# Turn multiple dataframes into one long data frame
dat <- do.call(rbind,lapply(dataframes,data.frame,stringsAsFactors=TRUE))
dat <- dat[,c('char','age','lake')]
```

Execute the method for building a composite biomass burning record used in Kelly et al. 2013 (10.1073/pnas.1305069110). The method estimates the parameters of a zero-inflated log-normal (ZIL) distribution of pooled charcoal counts in continuous moving windows of a user-defined width. In this analysis, 5-year and 50-year window widths are used (2.5 and 25 half-kernel widths, respectively).

This portion of the analysis is relegated to a separate R script for clarity of the workflow. Window widths and other parameters can be manipulated within the script.

```{r message=FALSE}
source(file = file.path(codeDir,"analysis_composite.R"))
```

Plot the result, a composite record of biomass burning.
```{r pressure}
ggplot(composite.df, aes(x=yrCE)) +
  geom_col(aes(y = highMean), fill = 'grey50', width = 5) +
  geom_ribbon(aes(ymin = lowCIlower, ymax = lowCIupper), alpha = 0.2) +
  geom_line(aes(y = lowMean)) +
  scale_x_continuous(limits = studyPeriod, 
                     breaks = seq(studyPeriod[1],studyPeriod[2],50)) +
  scale_y_continuous(breaks = c(0,1,2,3)) +
  labs(y = 'Biomass burning\n(standardized CHAR)', 
       x = 'Year CE') +
  coord_cartesian(ylim = c(0,3)) +
  theme_bw(base_size = 14) 
```


## Compare proxies