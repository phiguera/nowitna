---
title: "Analysis for Hoecker and Higuera XXXX: "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results  = 'hide', message = FALSE, warning = FALSE)
```

## Setup

Load the requisite packages.
```{r}
library(dplyr) # For data manipulation
library(zoo) # For rolling statistics 
library(ggplot2) # For plotting
library(knitr) # For formatting this file 
```

Specify lakes and time period of analysis.
```{r}
lakes = c('BB15','DU15','MA15','NW15','SH15','TL15','UR15') 
studyPeriod <- c(1550,2015)
```

Load charcoal data (data should be stored in the same directory as 'analysis.Rmd'). These data have already undergone peak analysis and interpolation in CharAnalysis (https://github.com/phiguera/CharAnalysis). Raw charcoal count data and CharAnalysis input files available here: [Figshare Link?]
```{r}
char.ldf = lapply(paste0(lakes,'_charResults.csv'),read.csv)   

char.df <- char.ldf %>%
  bind_rows() %>%
  mutate(ageCE = 1950 - ageTop,
         peakYr = ifelse(peaksFinal == 1,ageCE,NA),
         peakInsigYr = ifelse(peaksInsig == 1,ageCE,NA),
         peakYr1 = ifelse(peaks1 == 1,ageCE,NA),
         peakYr2 = ifelse(peaks2 == 1,ageCE,NA),
         peakYr3 = ifelse(peaks3 == 1,ageCE,NA)) %>%
  filter(ageCE >= studyPeriod[1]) %>%
  group_by(lake) %>%
         mutate(length = max(ageCE) - min(ageCE)) 
```
Load observed fire events
```{r}
observed.df <- read.csv('manual_fires_observed.csv')
obs.1km <- filter(observed.df,distance == 1.0) %>%
  rename(obsCE = ageCE)
```

## Summarize various charcoal record and fire history metrics 

Mean signal to noise indices of records during study period:
```{r results  = 'asis'}
kable(
  char.df %>% 
    summarise(meanSNI = mean(SNI, na.rm = T)) 
)
```

Study-wide mean FRI (mean of all FRI pooled, rather than mean of means):
```{r results  = 'asis'}
FRI <- char.df %>%
  select(lake,peakYr,length) %>%
  filter(!is.na(peakYr)) %>%
  mutate(FRI =  (lead(peakYr, 1) - peakYr) * -1) 

kable(
  FRI %>%
    ungroup(lake) %>%
    summarise(min = min(FRI, na.rm = T),
              max = max(FRI, na.rm = T),
              mean = mean(FRI, na.rm = T),
              median = median(FRI, na.rm = T),
              sd = sd(FRI, na.rm = T)) 
)
```

Individual mean FRI:
```{r results = 'asis'}
kable(
  FRI %>%
  group_by(lake) %>%
  summarise(nFires = n(),
            mFRI = mean(FRI, na.rm = T),
            sdFRI = sd(FRI, na.rm = T),
            length = length[1],
            FF = nFires/length * 100) 
)
```

Calculate the difference (in years) between observed fire years within 1km of lakes and the most recent fire event detected in charcoal record
```{r results = 'asis'}
char.df <- char.df %>%
  group_by(lake) %>%
  right_join(.,obs.1km, by = 'lake')

kable(
  char.df %>% 
  group_by(lake) %>%
  summarize(observed = obsCE[1],
            lastPeak = max(peakYr, na.rm = T),
            difference = abs(obsCE[1] - max(peakYr, na.rm = T)))
)
```





You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
